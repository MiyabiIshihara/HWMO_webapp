---
title: "leaflet_port"
author: "VanMcG"
date: "March 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(leaflet.extras)
library(sf)
library(geojsonio)
library(rgdal)
library(htmltools)
library(tidyverse)
library(spdep)
```


## Initialize map, add tiles
```{r}
m <- leaflet() %>%
  addProviderTiles(providers$OpenMapSurfer.Grayscale) %>%
  setView(-156, 20.35, 7) %>% #long, lat, zoom level 
  setMaxBounds(-162.6,23.6,-153.5,18.0) %>% 
  # the two diagonal pts that limit panning (long1, lat1, long2, lat2)
   addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Level 7",
    onClick=JS("function(btn, map){ map.setZoom(7); }")))

```

## Load data
```{r}
# Load Oahu subset of fire point data
OFires <- geojsonio::geojson_read("../wireframe/data/Oahu_Wildfires.geojson", what = "sp")

# Load census shp data
# EM: this should have worked by just calling from look_at_data.rmd, but whatever
census_dat = st_read("../wireframe/data/Census_Tract_All_Data/Census_Tract_All_Data.shp")

# Check coordinate reference system
st_crs(census_dat)

# Load haz data from geojson
haz_dat <- geojsonio::geojson_read("../data/WHA Metadata/WHA_zones.geojson", what = "sp")
st_crs(haz_dat)

# # Load haz from "look at data"
# haz_dat = st_read("../data/WHA Metadata/WHA2015.shp")
# # Check coordinate reference system
# st_crs(haz_dat)

# Polygon test
# addPolygons(m, data = census_dat) %>%
# addPolygons(data = haz_dat)
```


#Style things
``` {r}
# color palette for use in legends
palxyz <- colorQuantile(
  palette = "PuBuGn",
  domain = census_dat$MedH_Inc
)

# more to add later
```

#Map data
```{r}

# POINT DATA
  # test point for show
addMarkers(m, lng = -156.54, lat = 21.09, group = "Test point") %>% 

  # subset of fire data to test clustering
# addMarkers(lng = ~X, lat = ~Y, data = OFires@data, 
#            clusterOptions = markerClusterOptions(),
#            popup = paste("<b>Date of fire: </b></br>", OFires$Start_Date),
#            group = "Oahu fires") %>% 
#   
#Heatmap
  addHeatmap(lng = ~X, lat = ~Y, data = OFires,
             blur = 20, max = 0.05, radius = 15,
             group = "Oahu fires"
                  
                  ) %>%
  
#Polygon data
  # Subdivision Hazard Rating
  addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 5, haz_dat$SUBD_TOT) (SUBD_TOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 100.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName, #for test purposes
              popup = paste("<mark>",haz_dat$AreaName,
                            "</mark></br><b>Ingress/Egress: </b>", haz_dat$Ing_Eg,
                            "</br><b>Road maintenance: </b>", haz_dat$Rd_Maint,
                            "</br><b>Road width: </b>", haz_dat$Rd_Width,
                            "</br><b>Road condition: </b>", haz_dat$Rd_Cond,
                            "</br><b>Fire service access: </b>", haz_dat$Fire_Acc,
                            "</br><b>Street signs: </b>",  haz_dat$St_Sign,
                            "</br><b>Structure density: </b>", haz_dat$Strc_Den,
                            "</br><b>Home setbacks: </b>",haz_dat$Hm_Set,
                            "</br><b>Unmanaged lands: </b>",haz_dat$Un_Lands,
                            "</br><b>Private landowner action: </b>",haz_dat$Priv_Act,
                            "</br><b>Wildland proximity: </b>",haz_dat$Prox_Wild
               ),
              group = "Subdivision Hazard Rating") %>%
  #
  # Vegetation Hazard
  addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 5, haz_dat$VEG_TOT) (VEG_TOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName,
              popup = paste("<mark>",haz_dat$AreaName,
                            "</mark></br><b>Proximity of flamable fuel: </b>", haz_dat$Prox_Flam,
                            "</br><b>Vegetation type: </b>", haz_dat$Veg_Type,
                            "</br><b>Fuel loading: </b>", haz_dat$Fuel_Load,
                            "</br><b>Fuel structure: </b>", haz_dat$Fuel_Strc,
                            "</br><b>Defensible space: </b>", haz_dat$Def_Space
              ),
              group = "Vegetation Hazard Rating") %>%

  # Building Hazard Rating
  # this one is broken and I don't know why
  addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 3, haz_dat$BLDG_TOT) (BLDG_TOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName,
              popup = paste("<mark>",haz_dat$AreaName,
                            "</mark></br><b>Proximity of flamable fuel: </b>", haz_dat$Prox_Flam,
                            "</br><b>Roofing: </b>", haz_dat$Roof_Asmb,
                            "</br><b>Siding: </b>", haz_dat$Sid_Sof,
                            "</br><b>Under-skirting: </b>", haz_dat$Undr_Skrt,
                            "</br><b>Utilities placement: </b>", haz_dat$Utlty_Plmt,
                             "</br><b>Structural ignitability: </b>", haz_dat$Strc_Ign
              ),
              group = "Building Hazard Rating") %>%

  # Fire Environment
  addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 5, haz_dat$FIREHAZTOT) (FIREHAZTOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName,
              popup = paste("<mark>",haz_dat$AreaName,
                            "</mark></br><b>Slope: </b>", haz_dat$Slope,
                            "</br><b>Avg rain (1-6): </b>", haz_dat$Avg_Rain,
                            "</br><b>Prevailng wind (1-4): </b>", haz_dat$Prev_Wind,
                            "</br><b>Seasonal hazard condition: </b>", haz_dat$Seas_Haz,
                            "</br><b>Ignition risk: </b>", haz_dat$Ign_Risk,
                             "</br><b>Topography: </b>", haz_dat$Top_Adv
              ),
              group = "Fire Environment Hazard Rating") %>%
  
  # Fire Protection score
   addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 5, haz_dat$FIREPROTOT) (FIREPROTOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName, #for test purposes
              popup = paste("<mark>",haz_dat$AreaName,
                             "</mark></br><b>Water availability: </b>", haz_dat$Wat_Avail,
                            "</br><b>Response time: </b>", haz_dat$Rspn_Time,
                            "</br><b>Fire station proximity: </b>", haz_dat$Prox_Stn,
                            "</br><b>Fire dept training: </b>", haz_dat$FD_Trng,
                            "</br><b>Wildland firefighting capability: </b>", haz_dat$Wild_Cap,
                            "</br><b>Interagency cooperation: </b>", haz_dat$IntAgCoop,
                            "</br><b>Local emergency operations: </b>", haz_dat$Loc_Ops,
                            "</br><b>Community planning: </b>", haz_dat$Com_Plan,
                            "</br><b>Community fire programs: </b>", haz_dat$Com_FirPrg
                            ),
              popupOptions = popupOptions(style = list("color" = "black")),
              group = "Fire Protection Score"
              ) %>%
  addLegend(pal = palxyz, values = haz_dat$FIREPROTOT, title = "Fire Protection", position = "bottomright", group = 'Fire Protection Score') %>%

  

  # MedH_Inc
addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("PuBuGn", n = 5, MedH_Inc) (MedH_Inc),
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              popup = paste("<b>Median household income: </b></br>$", census_dat$MedH_Inc), #for test purposes
             
              group = "Median HH income"
  ) %>%
  
  # NH_ac
  addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("Reds", n = 5, NH_ac) (NH_ac),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              label = paste("NH_ac: ", census_dat$NH_ac), #for test purposes
              group = "NH_ac"
  ) %>%
    # NOTE: possible we have to add legends for each polygon layer 
    # however, switching functionality seems broken with base layers in library
    #

    # addLegend(pal = palxyz, values = census_dat$NH_ac, title = "people", position = "bottomright", group = 'NH_ac') %>%
      
      # "bottomright", values = ~NH_ac,
      #       pal = "Reds",
      #     #  group = "NH_ac",
      #      #group as unused argument. Don't understand the error here
      #       opacity = 1,
      #       labels = census_dat$NH_ac
# EXAMPLE
#   addLegend(pal = factpalA, values = dens_pop$dens_pop, opacity = 0.7, title = "Hab./Km2", position = "bottomright", group = 'Densidade Populacional')
  
  # homeowners
  addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlGnBu", n = 5, Homeowner) (Homeowner),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              popup = paste("<b>Homeowners: </b>", census_dat$Homeowner,"%"), #for test purposes
              group = "Homeowners"
  ) %>%
  

# LAYER CONTROLS
  addLayersControl(
    # base groups = radio buttons

    overlayGroups = c("Oahu fires", "Subdivision Hazard Rating", "Vegetation Hazard Rating", "Building Hazard Rating", "Fire Environment Hazard Rating", "Fire Protection Score", "Median HH income",  
                  "NH_ac", "Homeowners"),
    # #  overlay groups = check boxes
    # overlayGroups = c("Oahu fires", "Test point"),
    options = layersControlOptions(collapsed = FALSE,
                                   sortLayers = FALSE)
  ) %>%
  hideGroup("Subdivision Hazard Rating") %>%
  hideGroup("Vegetation Hazard Rating") %>%
  hideGroup("Building Hazard Rating") %>%
  hideGroup("Fire Environment Hazard Rating") %>%
  hideGroup("Fire Protection Score") %>%
  hideGroup("Median HH income") %>%
  hideGroup("NH_ac") %>%
  hideGroup("Homeowners")
  


```

#### Some notes
* current sf objects need to be modified so that num columns are int instead
** num doesn't work for popups; feature doesn't work for choropleth
* Legends are easy to make for each layer, but hard to flip between
** this is apparently fixed for overlay layers, but possibly still in progress for base layers
** Layers control should work, but assigning the legend a group rends an "argument not used" error
** a strange workaround to try here: https://stackoverflow.com/questions/40770641/how-to-hide-toggle-legends-based-on-addlayercontrol-in-leaflet-for-r


##Legend code
```{r}
# NOTE: dummy code for demo only
  # addLegend(m, "bottomright", pal = palxyz, values = census_dat$MedH_Inc,
  #         title = "Med.HH Income ($)",
  #         opacity = 1
  #         )
```


