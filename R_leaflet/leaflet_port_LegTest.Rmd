---
title: "leaflet_port_LegTest"
author: "VanMcG"
date: "3/29/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(leaflet.extras)
library(sf)
library(geojsonio)
library(rgdal)
library(htmltools)
library(tidyverse)
library(spdep)
```

# initialize map
```{r}
m <- leaflet() %>%
  addProviderTiles(providers$OpenMapSurfer.Grayscale) %>%
  setView(-156, 20.35, 7) %>% #long, lat, zoom level 
  setMaxBounds(-162.6,23.6,-153.5,18.0) %>% 
  # the two diagonal pts that limit panning (long1, lat1, long2, lat2)
   addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Level 7",
    onClick=JS("function(btn, map){ map.setZoom(7); }")))

```

# load data
```{r}
# Load Oahu subset of fire point data
OFires <- geojsonio::geojson_read("../wireframe/data/Oahu_Wildfires.geojson", what = "sp")

# Load census shp data
# EM: this should have worked by just calling from look_at_data.rmd, but whatever
census_dat = st_read("../wireframe/data/Census_Tract_All_Data/Census_Tract_All_Data.shp")
# Check coordinate reference system
st_crs(census_dat)

# Load haz data from geojson
haz_dat <- geojsonio::geojson_read("../data/WHA Metadata/WHA_zones.geojson", what = "sp")
st_crs(haz_dat)


#STYLE THINGS

# color palette for use in legends
pal1 <- colorNumeric(
  palette = "PuBuGn",
  domain = haz_dat$SUBD_TOT
)

pal2 <- colorQuantile(
  palette = "RdBu",
  domain = haz_dat$FIREPROTOT
)
```


# Legend docs
* general show/hide doc: https://rstudio.github.io/leaflet/showhide.html
* this is where they say the issue is closed: https://github.com/rstudio/leaflet/issues/471
  ** issues 471 and 456 were both closed past the most recent release date (feb 2017)...is the a version issue?
  ** another related issue, unclosed: https://github.com/rstudio/leaflet/issues/477 
* the stack exchange post that leads to the above issue doc: https://gis.stackexchange.com/questions/214773/how-to-hide-toggle-legends-with-layer-controls-in-leaflet-for-r
* a post wrt shiny integration of legends that might be useful (will try if can't get it to work independently): https://stackoverflow.com/questions/47252337/how-to-connect-legends-to-layer-groups-on-shiny-apps

### still more stuff
* a leaflet.js example solution to the same question that might be of use: https://gis.stackexchange.com/questions/124847/legend-items-to-appear-disappear-simultaneaously-with-layer-turned-on-off-in-l
* 
* 

# the map
```{r}
  # Subdivision Hazard Rating
  addPolygons(m, data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile(pal1, n = 3, haz_dat$SUBD_TOT) (SUBD_TOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 100.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName, #for test purposes
              # temporary style until build a proper css file
              popup = paste("<h3 align = 'right'><b>",haz_dat$AreaName, "</b></h3><h5 align ='right'>Total score: <b>", haz_dat$SUBD_TOT, "</font></b>",
                            "</mark></h5><p align ='right'></br>Ingress/Egress: <b>", haz_dat$Ing_Eg,
                            "</br></b>Road maintenance: <b>", haz_dat$Rd_Maint,
                            "</br></b>Road width: <b>", haz_dat$Rd_Width,
                            "</br></b>Road condition: <b>", haz_dat$Rd_Cond,
                            "</br></b>Fire service access: <b>", haz_dat$Fire_Acc,
                            "</br></b>Street signs: <b>",  haz_dat$St_Sign,
                            "</br></b>Structure density: <b>", haz_dat$Strc_Den,
                            "</br></b>Home setbacks: <b>",haz_dat$Hm_Set,
                            "</br></b>Unmanaged lands: <b>",haz_dat$Un_Lands,
                            "</br></b>Private landowner action: <b>",haz_dat$Priv_Act,
                            "</br></b>Wildland proximity: <b>",haz_dat$Prox_Wild, "</b>"
               ),
              group = "SubD") %>%
              addLegend(pal = pal1, title = "SubD", labels = haz_dat$SUBD_TOT, values = haz_dat$SUBD_TOT
                        #, group = "SubD" #this only will work with a dev version of the library, I think. Checking with my roommate the data scientist when he gets home.
              ) %>%
  
    # Fire Protection score
   addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile(pal2, n = 5, haz_dat$FIREPROTOT) (FIREPROTOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName, #for test purposes
              popup = paste("<style",haz_dat$AreaName,
                             "</br><b>Water availability: </b>", haz_dat$Wat_Avail,
                            "</br><b>Response time: </b>", haz_dat$Rspn_Time,
                            "</br><b>Fire station proximity: </b>", haz_dat$Prox_Stn,
                            "</br><b>Fire dept training: </b>", haz_dat$FD_Trng,
                            "</br><b>Wildland firefighting capability: </b>", haz_dat$Wild_Cap,
                            "</br><b>Interagency cooperation: </b>", haz_dat$IntAgCoop,
                            "</br><b>Local emergency operations: </b>", haz_dat$Loc_Ops,
                            "</br><b>Community planning: </b>", haz_dat$Com_Plan,
                            "</br><b>Community fire programs: </b>", haz_dat$Com_FirPrg
                            ),
              popupOptions = popupOptions(style = list("color" = "black")),
              group = "FProt"
              ) %>%
  
    addLegend(pal = pal2, labels = haz_dat$FIREPROTOT, values = haz_dat$FIREPROTOT
              #, group = "FProt" #this only will work with a dev version of the library, I think. Checking with my roommate the data scientist when he gets home.
              ) %>%
  
  
  
  # addLegend(pal = palxyz, values = haz_dat$FIREPROTOT, title = "Fire Protection", position = "bottomright", group = 'Fire Protection Score') %>%
  
  # LAYER CONTROLS
  addLayersControl(
    # base groups = radio buttons
    overlayGroups = c("SubD","FProt"),
    # #  overlay groups = check boxes
    # overlayGroups = c("Oahu fires", "Test point"),
    options = layersControlOptions(collapsed = FALSE,
                                   sortLayers = FALSE)
  ) %>%
  
  hideGroup("FProt")
  
  
```