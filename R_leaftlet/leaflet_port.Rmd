---
title: "leaflet_port"
author: "VanMcG"
date: "March 14, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(leaflet)
library(sf)
library(geojsonio)
library(rgdal)
library(htmltools)
library(tidyverse)
library(spdep)
```


## Initialize map, add tiles
```{r}
m <- leaflet() %>%
  addProviderTiles(providers$OpenMapSurfer.Grayscale) %>%
  setView(-156, 20.35, 8) %>% #long, lat, zoom level 
  setMaxBounds(-162.6,23.6,-153.5,18.0) %>% 
  # the two diagonal pts that limit panning (long1, lat1, long2, lat2)
   addEasyButton(easyButton(
    icon="fa-globe", title="Zoom to Level 8",
    onClick=JS("function(btn, map){ map.setZoom(8); }")))

```

## Load data
```{r}
# Load Oahu subset of fire point data
OFires <- geojsonio::geojson_read("../data/Fire History/Oahu_Wildfires.geojson", what = "sp")

# Load census shp data
# EM: this should have worked by just calling from look_at_data.rmd, but whatever
census_dat = st_read("../data/Census_Tract_All_Data/Census_Tract_All_Data.shp")
# Check coordinate reference system
st_crs(census_dat)

# Load haz data from geojson
haz_dat <- geojsonio::geojson_read("../data/WHA Metadata/WHA_zones_choro.geojson", what = "sp")

# Polygon test
# addPolygons(m, data = census_dat) %>%
# addPolygons(data = haz_dat)
```


#Style things
``` {r}
# color palette for use in legends
palxyz <- colorQuantile(
  palette = "PuBuGn",
  domain = census_dat$MedH_Inc
)

# more to add later
```

#Map data
```{r}

# POINT DATA
  # test point for show
addMarkers(m, lng = -156.54, lat = 21.09, group = "Test point") %>% 

  # subset of fire data to test clustering
addMarkers(lng = ~X, lat = ~Y, data = OFires@data, 
           clusterOptions = markerClusterOptions(),
           popup = paste("<b>Date of fire: </b></br>", OFires$Start_Date),
           group = "Oahu fires") %>% 
  
#Polygon data
  # MedH_Inc
addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("PuBuGn", n = 5, MedH_Inc) (MedH_Inc),
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              popup = paste("<b>Median household income: </b></br>$", census_dat$MedH_Inc), #for test purposes
             
              group = "Median HH income"
  ) %>%
  
  # NH_ac
  addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("Reds", n = 5, NH_ac) (NH_ac),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              label = paste("NH_ac: ", census_dat$NH_ac), #for test purposes
              group = "NH_ac"
  ) %>%
    # NOTE: possible we have to add legends for each polygon layer 
    # however, switching functionality seems broken with base layers in library
    #
    # addLegend("bottomright", values = ~NH_ac,
    #         colors = "Reds",
    #         group = "NH_ac",
    #        #group as unused argument. Don't understand the error here
    #         opacity = 1,
    #         labels = census_dat$NH_ac
    #       
    #       ) %>%
  
    # fire protection score
   addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlOrBr", n = 5, haz_dat$FIREPROTOT) (FIREPROTOT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              #label = haz_dat$AreaName, #for test purposes
              popup = paste("<mark>",haz_dat$AreaName,
                            "</mark></br><b>Fire protection score: </b>",
                            haz_dat$FIREPROTOT, "</br><b>Fire hazard score: </b>",
                            haz_dat$FIREHAZTOT, "</br><b>CAR rating: </b>",
                            haz_dat$CAR_Rating),
              group = "Fire Protection Score") %>%
  
  # fire count (calculated in QGIS before creating geojson)
  addPolygons(data = haz_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("Oranges", n = 5, haz_dat$COUNT) (COUNT),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505", 
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              popup = paste("<b>Number of fires: </b></br>", haz_dat$COUNT),
              group = "Fire incidence") %>%
  
  # homeowners
  addPolygons(data = census_dat, color = '#000000', weight = 1,
              fillColor = ~colorQuantile("YlGnBu", n = 5, Homeowner) (Homeowner),
              opacity = 1.0,
              highlightOptions = highlightOptions(stroke = "#ff0505",
                                                  weight = 4.0,
                                                  opacity = 1.0,
                                                  bringToFront = TRUE),
              popup = paste("<b>Homeowners: </b>", census_dat$Homeowner,"%"), #for test purposes
              group = "Homeowners"
  ) %>%
  

# LAYER CONTROLS
  addLayersControl(
    # base groups = radio buttons
    baseGroups = c("Median HH income", "Fire Protection Score", 
                   "Fire incidence", "NH_ac", "Homeowners"),
    # overlay groups = check boxes
    overlayGroups = c("Oahu fires", "Test point"),
    options = layersControlOptions(collapsed = FALSE,
                                   sortLayers = FALSE)
  ) 
  


```

#### Some notes
* current sf objects need to be modified so that num columns are int instead
** num doesn't work for popups; feature doesn't work for choropleth
* Legends are easy to make for each layer, but hard to flip between
** this is apparently fixed for overlay layers, but possibly still in progress for base layers
** Layers control should work, but assigning the legend a group rends an "argument not used" error
** a strange workaround to try here: https://stackoverflow.com/questions/40770641/how-to-hide-toggle-legends-based-on-addlayercontrol-in-leaflet-for-r


##Legend code
```{r}
# NOTE: dummy code for demo only
  # addLegend(m, "bottomright", pal = palxyz, values = census_dat$MedH_Inc,
  #         title = "Med.HH Income ($)",
  #         opacity = 1
  #         )
```


