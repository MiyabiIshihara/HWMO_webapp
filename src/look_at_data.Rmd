---
title: "Exploring the HWMO data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(sf)
library(tidyverse)
library(spdep)
library(leaflet)
```

`sf` Resources:
<https://ryanpeek.github.io/mapping_in_R/index.html>
<https://edzer.github.io/rstudio_conf/#1>

```{r load hazard assessment data}
# Load data
haz_dat = st_read("../data/WHA Metadata/WHA2015.shp")
# Check coordinate reference system
st_crs(haz_dat)

haz_dat <- st_transform(haz_dat, "+proj=longlat +datum=WGS84")

# Plot
#plot(st_geometry(haz_dat), col="white")
#haz_dat %>%
#ggplot() +
#  geom_sf() +
#  aes(fill = SUBD_TOT) + 
#  theme(panel.grid.major = element_line(color = "white")) +
#  scale_fill_gradientn(colors = sf.colors(20))
# View data
#View(haz_dat)
```

```{r make hazard assessment tidy}
#haz_dat <- haz_dat %>%
#  select(SUBD_TOT, VEG_TOT, BLDG_TOT, FIREHAZTOT,FIREPROTOT,
#         # Acres, AREA, PERIMETER, CAR_Rating, 
#         AreaName, Island, -geometry)

tidy_haz <- haz_dat %>% 
  as.data.frame %>%
  select(-c(geometry)) %>%
  gather(key = hazard, 
         value = score, 
         -c(AreaName, Island,AREA, PERIMETER,
            Acres, IntAgCoop, CAR_Rating, zone, 
            CAR_Hawaii, CAR_adjtot)) %>%
  mutate(
    hazard_category = 
    case_when(
    hazard %in% c("Wat_Avail", "Rspn_Time", "Prox_Stn",
                  "FD_Trng", "Wild_Cap", "IntAgCoop",
                  "Loc_Ops", "Com_Plan", "Com_FirPrg") ~ "Fire Protection",
    hazard %in% c("Ing_Eg", "Rd_Maint","Rd_Width",
                  "Rd_Cond", "Fire_Acc", "St_Sign",
                  "Strc_Den", "Hm_Set", "Un_Lands",
                  "Priv_Act", "Prox_Wild") ~ "Subdivision",
    hazard %in% c("Veg_Type", "Fuel_Load", "Fuel_Strc",
                  "Def_Space", "Prox_Flam") ~ "Vegetation",
    hazard %in% c("Roof_Asmb", "Sid_Sof", "Undr_Skrt",
                  "Utlty_Plmt", "Strc_Ign") ~ "Building",
    hazard %in% c("Slope", "Avg_Rain", "Prev_Wind",
                  "Seas_Haz", "Ign_Risk", "Top_Adv") ~ "Fire Environment"
  ))
tidy_haz_test <- tidy_haz %>%
  mutate(
    reason =
      case_when(
        hazard == "Ing_Eg" & score == 1 ~ "Multiple entrances and exits are well equipped for fire trucks with turnarounds",
        hazard == "Ing_Eg" & score == 2 ~ "Limited access routes. 2 ways in and 2 ways out. Moderate grades",
        hazard == "Ing_Eg" & score == 3 ~ "Narrow, dead end roads or 1 way in, 1 way out. Steep grades",
        hazard == "Rd_Maint" & score == 1 ~ "Wide loop roads that are maintained, paved or solid surface with shoulders",
        hazard == "Rd_Maint" & score == 2 ~ "Roads maintained. Some narrow two lane roads with no shoulders",
        hazard == "Rd_Maint" & score == 3 ~ "Narrow and or single lane, minimally maintained, no shoulders"
      )
  )
levels(as.factor(tidy_haz_test$reason))

write_csv(tidy_haz, "../wireframe/data/tidy_haz.csv")


census_dat = st_read("../data/Census_Tract_All_Data/Census_Tract_All_Data.shp")
# Check coordinate reference system
st_crs(census_dat)
#convert to factor as test
census_dat$Homeowner <- as.integer(census_dat$Homeowner)
census_dat$MedH_Inc <- as.integer(census_dat$MedH_Inc)

# Plot
plot(st_geometry(census_dat), col="white")
# View data
View(census_dat)



```

HWMO-given census variables:
- Bachelors Degree or Higher: BD_Higher
- Homeownership Rate: Homeowner
- Median Household Income: MedH_Inc
- Native Hawaiian alone or in combination with another race: NH_ac
- Native Hawaiian and Other Pacific Islanders alone or in combination with another race: NH_PI_ac
- Other Pacific Islanders alone or in combination with another race: PI_a 
Other variables to consider: <https://www.epa.gov/ejscreen/overview-demographic-indicators-ejscreen>

```{r load fire history data}
# Load data
fire_dat = st_read("../data/Fire History/HI_Wildfires1.shp")
# Check coordinate reference system
st_crs(fire_dat)
# Plot
fire_dat %>%
  filter(Long < -50) %>%
  ggplot() + 
  geom_point(aes(x= Long, y = Lat))
# View data
View(fire_dat)
```

```{r load community input data}
# Load data
comm_input_dat <-
    # this generates the list of files
    list.files(path = "../data/community_input/",
               pattern="*.csv", 
               full.names = T) %>% 
    # map over read_csv, col_types specifies that each have same column headers
    map_dfr(~read_csv(., col_types = cols(.default = "c"))) 
```

```{r clean community input data}
## split secondary desc (should be 15 total)
comm_input_dat <- comm_input_dat %>%
    mutate(
      # combines firewise and Firewise
      secondary_desc = tolower(secondary_desc),
      # combines collab and Collab
      key_codes = tolower(key_codes)
           ) %>%
    separate(secondary_desc, c("sec_desc1", "sec_desc2", "sec_desc3"), ",")

# Remove potentially complicating $ and '
comm_input_dat$sec_desc1<-gsub("\\$", "money", comm_input_dat$sec_desc1)
comm_input_dat$sec_desc1<-gsub("\\'", "", comm_input_dat$sec_desc1)
# Remove all items after - (e.g. to- ll)
comm_input_dat$sec_desc1<-gsub("\\-.*", "", comm_input_dat$sec_desc1)

# Manipulate data
comm_input_dat <- comm_input_dat %>% 
  mutate(total_votes = as.numeric(total_votes)) %>%
  mutate_if(is.character,funs(factor(.))) %>%
  mutate(concern = as.character(concern),
         recommendations = as.character(recommendations))

write_csv(comm_input_dat,"../data/comm_input.csv")
```

```{r read clean community input data}

comm_input_dat <- read_csv("../wireframe/data/comm_input.csv")
```








